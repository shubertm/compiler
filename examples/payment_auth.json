{
  "contractName": "PaymentAuthorization",
  "constructorInputs": [
    {
      "name": "server",
      "type": "pubkey"
    },
    {
      "name": "invoiceAmount",
      "type": "int"
    },
    {
      "name": "feeRateBasisPoints",
      "type": "int"
    },
    {
      "name": "merchantScript",
      "type": "bytes"
    },
    {
      "name": "processorScript",
      "type": "bytes"
    },
    {
      "name": "customerScript",
      "type": "bytes"
    },
    {
      "name": "refundBlockHeight",
      "type": "int"
    },
    {
      "name": "merchantPubkey",
      "type": "pubkey"
    }
  ],
  "functions": [
    {
      "name": "capture",
      "functionInputs": [
        {
          "name": "merchantSig",
          "type": "signature"
        }
      ],
      "serverVariant": true,
      "require": [
        {
          "type": "signature"
        },
        {
          "type": "comparison"
        },
        {
          "type": "comparison"
        },
        {
          "type": "comparison"
        },
        {
          "type": "comparison"
        },
        {
          "type": "comparison"
        },
        {
          "type": "comparison"
        },
        {
          "type": "comparison"
        },
        {
          "type": "comparison"
        },
        {
          "type": "comparison"
        },
        {
          "type": "comparison"
        },
        {
          "type": "comparison"
        },
        {
          "type": "comparison"
        },
        {
          "type": "comparison"
        },
        {
          "type": "comparison"
        },
        {
          "type": "comparison"
        },
        {
          "type": "comparison"
        },
        {
          "type": "comparison"
        },
        {
          "type": "comparison"
        },
        {
          "type": "serverSignature"
        }
      ],
      "asm": [
        "<merchantPubkey>",
        "<merchantSig>",
        "OP_CHECKSIG",
        "OP_INPUTVALUE",
        "<vtxoValue>",
        "OP_SCRIPTNUMTOLE64",
        "<invoiceAmount>",
        "OP_SCRIPTNUMTOLE64",
        "OP_LESSTHAN64",
        "OP_VERIFY",
        "OP_IF",
        "<vtxoValue>",
        "OP_GREATERTHANOREQUAL",
        "10000",
        "OP_INSPECTNUMOUTPUTS",
        "2",
        "OP_EQUAL",
        "<vtxoValue>",
        "OP_SCRIPTNUMTOLE64",
        "<feeRateBasisPoints>",
        "OP_SCRIPTNUMTOLE64",
        "OP_MUL64",
        "OP_VERIFY",
        "10000",
        "OP_DIV64",
        "OP_VERIFY",
        "<vtxoValue>",
        "OP_SCRIPTNUMTOLE64",
        "<processorFee>",
        "OP_SCRIPTNUMTOLE64",
        "OP_SUB64",
        "OP_VERIFY",
        "0",
        "OP_INSPECTOUTPUTVALUE",
        "<merchantAmount>",
        "OP_EQUAL",
        "OP_VERIFY",
        "0",
        "OP_INSPECTOUTPUTSCRIPTPUBKEY",
        "<merchantScript>",
        "OP_EQUAL",
        "1",
        "OP_INSPECTOUTPUTVALUE",
        "<processorFee>",
        "OP_EQUAL",
        "OP_VERIFY",
        "1",
        "OP_INSPECTOUTPUTSCRIPTPUBKEY",
        "<processorScript>",
        "OP_EQUAL",
        "OP_ENDIF",
        "<vtxoValue>",
        "OP_SCRIPTNUMTOLE64",
        "<invoiceAmount>",
        "OP_SCRIPTNUMTOLE64",
        "OP_EQUAL",
        "OP_IF",
        "OP_INSPECTNUMOUTPUTS",
        "2",
        "OP_EQUAL",
        "<invoiceAmount>",
        "OP_SCRIPTNUMTOLE64",
        "<feeRateBasisPoints>",
        "OP_SCRIPTNUMTOLE64",
        "OP_MUL64",
        "OP_VERIFY",
        "10000",
        "OP_DIV64",
        "OP_VERIFY",
        "<invoiceAmount>",
        "OP_SCRIPTNUMTOLE64",
        "<processorFee>",
        "OP_SCRIPTNUMTOLE64",
        "OP_SUB64",
        "OP_VERIFY",
        "0",
        "OP_INSPECTOUTPUTVALUE",
        "<merchantAmount>",
        "OP_EQUAL",
        "OP_VERIFY",
        "0",
        "OP_INSPECTOUTPUTSCRIPTPUBKEY",
        "<merchantScript>",
        "OP_EQUAL",
        "1",
        "OP_INSPECTOUTPUTVALUE",
        "<processorFee>",
        "OP_EQUAL",
        "OP_VERIFY",
        "1",
        "OP_INSPECTOUTPUTSCRIPTPUBKEY",
        "<processorScript>",
        "OP_EQUAL",
        "OP_ENDIF",
        "<vtxoValue>",
        "OP_SCRIPTNUMTOLE64",
        "<invoiceAmount>",
        "OP_SCRIPTNUMTOLE64",
        "OP_GREATERTHAN64",
        "OP_VERIFY",
        "OP_IF",
        "OP_INSPECTNUMOUTPUTS",
        "3",
        "OP_EQUAL",
        "<invoiceAmount>",
        "OP_SCRIPTNUMTOLE64",
        "<feeRateBasisPoints>",
        "OP_SCRIPTNUMTOLE64",
        "OP_MUL64",
        "OP_VERIFY",
        "10000",
        "OP_DIV64",
        "OP_VERIFY",
        "<invoiceAmount>",
        "OP_SCRIPTNUMTOLE64",
        "<processorFee>",
        "OP_SCRIPTNUMTOLE64",
        "OP_SUB64",
        "OP_VERIFY",
        "<vtxoValue>",
        "OP_SCRIPTNUMTOLE64",
        "<invoiceAmount>",
        "OP_SCRIPTNUMTOLE64",
        "OP_SUB64",
        "OP_VERIFY",
        "0",
        "OP_INSPECTOUTPUTVALUE",
        "<merchantAmount>",
        "OP_EQUAL",
        "OP_VERIFY",
        "0",
        "OP_INSPECTOUTPUTSCRIPTPUBKEY",
        "<merchantScript>",
        "OP_EQUAL",
        "1",
        "OP_INSPECTOUTPUTVALUE",
        "<processorFee>",
        "OP_EQUAL",
        "OP_VERIFY",
        "1",
        "OP_INSPECTOUTPUTSCRIPTPUBKEY",
        "<processorScript>",
        "OP_EQUAL",
        "2",
        "OP_INSPECTOUTPUTVALUE",
        "<changeAmount>",
        "OP_EQUAL",
        "OP_VERIFY",
        "2",
        "OP_INSPECTOUTPUTSCRIPTPUBKEY",
        "<customerScript>",
        "OP_EQUAL",
        "OP_ENDIF",
        "<SERVER_KEY>",
        "<serverSig>",
        "OP_CHECKSIG"
      ]
    },
    {
      "name": "capture",
      "functionInputs": [
        {
          "name": "merchantSig",
          "type": "signature"
        },
        {
          "name": "merchantPubkeySig",
          "type": "signature"
        }
      ],
      "serverVariant": false,
      "require": [
        {
          "type": "nOfNMultisig",
          "message": "1-of-1 signatures required (introspection fallback)"
        },
        {
          "type": "older",
          "message": "Exit timelock of 144 blocks"
        }
      ],
      "asm": [
        "<merchantPubkey>",
        "<merchantPubkeySig>",
        "OP_CHECKSIG",
        "144",
        "OP_CHECKSEQUENCEVERIFY",
        "OP_DROP"
      ]
    },
    {
      "name": "refund",
      "functionInputs": [],
      "serverVariant": true,
      "require": [
        {
          "type": "older",
          "message": "Timelock of 0 blocks"
        },
        {
          "type": "comparison"
        },
        {
          "type": "comparison"
        },
        {
          "type": "comparison"
        },
        {
          "type": "serverSignature"
        }
      ],
      "asm": [
        "<refundBlockHeight>",
        "OP_CHECKLOCKTIMEVERIFY",
        "OP_DROP",
        "OP_INPUTVALUE",
        "OP_INSPECTNUMOUTPUTS",
        "1",
        "OP_EQUAL",
        "0",
        "OP_INSPECTOUTPUTVALUE",
        "<vtxoValue>",
        "OP_EQUAL",
        "OP_VERIFY",
        "0",
        "OP_INSPECTOUTPUTSCRIPTPUBKEY",
        "<customerScript>",
        "OP_EQUAL",
        "<SERVER_KEY>",
        "<serverSig>",
        "OP_CHECKSIG"
      ]
    },
    {
      "name": "refund",
      "functionInputs": [
        {
          "name": "merchantPubkeySig",
          "type": "signature"
        }
      ],
      "serverVariant": false,
      "require": [
        {
          "type": "nOfNMultisig",
          "message": "1-of-1 signatures required (introspection fallback)"
        },
        {
          "type": "older",
          "message": "Exit timelock of 144 blocks"
        }
      ],
      "asm": [
        "<merchantPubkey>",
        "<merchantPubkeySig>",
        "OP_CHECKSIG",
        "144",
        "OP_CHECKSEQUENCEVERIFY",
        "OP_DROP"
      ]
    }
  ],
  "source": "// Payment Authorization Contract\n// Authorization-based escrow with timelocked refunds using transaction introspection\n//\n// This contract implements a credit card-like payment flow:\n// 1. Customer locks funds in escrow\n// 2. Merchant can capture (authorize and settle) the payment\n// 3. If not captured, customer can refund after timelock expires\n//\n// The contract validates the full payout structure:\n// - Merchant receives payment minus processor fee\n// - Processor receives fee (basis points of payment)\n// - Customer receives change if overpayment\n\noptions {\n  server = server;\n  exit = 144;\n}\n\ncontract PaymentAuthorization(\n  // Server key for cooperative path\n  pubkey server,\n\n  // Payment terms\n  int invoiceAmount,\n  int feeRateBasisPoints,\n\n  // Output scripts (P2TR scriptPubKeys)\n  bytes merchantScript,\n  bytes processorScript,\n  bytes customerScript,\n\n  // Refund timelock (block height)\n  int refundBlockHeight,\n\n  // Authorization key\n  pubkey merchantPubkey\n) {\n\n  // Capture: merchant-authorized settlement\n  // Validates payout structure based on payment amount vs invoice\n  function capture(signature merchantSig) {\n    require(checkSig(merchantSig, merchantPubkey), \"Invalid merchant signature\");\n\n    // Get the current input value (amount locked in escrow)\n    let vtxoValue = tx.input.current.value;\n\n    // Case 1: Underpayment (vtxoValue < invoiceAmount)\n    // Pay merchant (minus fee) + processor fee\n    if (vtxoValue < invoiceAmount) {\n      require(vtxoValue >= 10000, \"Payment below dust threshold\");\n      require(tx.numOutputs == 2, \"Expected 2 outputs for underpayment\");\n\n      // Fee = vtxoValue * feeRateBasisPoints / 10000\n      let processorFee = (vtxoValue * feeRateBasisPoints) / 10000;\n      let merchantAmount = vtxoValue - processorFee;\n\n      require(tx.outputs[0].value == merchantAmount, \"Merchant amount incorrect\");\n      require(tx.outputs[0].scriptPubKey == merchantScript, \"Merchant script incorrect\");\n\n      require(tx.outputs[1].value == processorFee, \"Processor fee incorrect\");\n      require(tx.outputs[1].scriptPubKey == processorScript, \"Processor script incorrect\");\n    }\n\n    // Case 2: Exact payment (vtxoValue == invoiceAmount)\n    // Pay merchant (minus fee) + processor fee\n    if (vtxoValue == invoiceAmount) {\n      require(tx.numOutputs == 2, \"Expected 2 outputs for exact payment\");\n\n      // Fee = invoiceAmount * feeRateBasisPoints / 10000\n      let processorFee = (invoiceAmount * feeRateBasisPoints) / 10000;\n      let merchantAmount = invoiceAmount - processorFee;\n\n      require(tx.outputs[0].value == merchantAmount, \"Merchant amount incorrect\");\n      require(tx.outputs[0].scriptPubKey == merchantScript, \"Merchant script incorrect\");\n\n      require(tx.outputs[1].value == processorFee, \"Processor fee incorrect\");\n      require(tx.outputs[1].scriptPubKey == processorScript, \"Processor script incorrect\");\n    }\n\n    // Case 3: Overpayment (vtxoValue > invoiceAmount)\n    // Pay merchant (minus fee) + processor fee + customer change\n    if (vtxoValue > invoiceAmount) {\n      require(tx.numOutputs == 3, \"Expected 3 outputs for overpayment\");\n\n      // Fee = invoiceAmount * feeRateBasisPoints / 10000\n      let processorFee = (invoiceAmount * feeRateBasisPoints) / 10000;\n      let merchantAmount = invoiceAmount - processorFee;\n      let changeAmount = vtxoValue - invoiceAmount;\n\n      require(tx.outputs[0].value == merchantAmount, \"Merchant amount incorrect\");\n      require(tx.outputs[0].scriptPubKey == merchantScript, \"Merchant script incorrect\");\n\n      require(tx.outputs[1].value == processorFee, \"Processor fee incorrect\");\n      require(tx.outputs[1].scriptPubKey == processorScript, \"Processor script incorrect\");\n\n      require(tx.outputs[2].value == changeAmount, \"Change amount incorrect\");\n      require(tx.outputs[2].scriptPubKey == customerScript, \"Change script incorrect\");\n    }\n  }\n\n  // Refund: timelocked fallback back to customer\n  // Becomes valid after refundBlockHeight - effectively anyone-can-spend into customerScript\n  function refund() {\n    require(tx.time >= refundBlockHeight, \"Refund timelock not reached\");\n\n    let vtxoValue = tx.input.current.value;\n\n    require(tx.numOutputs == 1, \"Expected 1 output for refund\");\n    require(tx.outputs[0].value == vtxoValue, \"Refund amount incorrect\");\n    require(tx.outputs[0].scriptPubKey == customerScript, \"Refund script incorrect\");\n  }\n}\n",
  "compiler": {
    "name": "arkade-compiler",
    "version": "0.1.0"
  },
  "updatedAt": "2026-02-10T21:56:38.764020+00:00"
}